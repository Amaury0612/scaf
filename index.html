<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-Odyssey Online | MMO Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --ui-blue: #00f2ff;
            --ui-pink: #ff00ff;
            --ui-orange: #ffaa00;
            --bg-dark: #020617;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-dark);
            color: var(--ui-blue);
            font-family: 'JetBrains Mono', monospace;
        }

        #canvas-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        /* --- HUD --- */
        #hud {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .stat-panel {
            background: rgba(0, 10, 20, 0.7);
            border: 1px solid var(--ui-blue);
            padding: 15px;
            backdrop-filter: blur(5px);
            border-radius: 4px;
        }

        .quest-tracker {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 250px;
            border-left: 3px solid var(--ui-orange);
        }

        .label { font-size: 10px; opacity: 0.7; text-transform: uppercase; margin-bottom: 5px; }
        .value { font-family: 'Orbitron', sans-serif; font-size: 14px; color: #fff; }
        .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); margin-top: 8px; position: relative; overflow: hidden;}
        #hp-fill { height: 100%; width: 100%; background: var(--ui-blue); transition: width 0.3s; }
        #quest-progress { color: var(--ui-orange); font-size: 12px; }

        #dialogue-box {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            background: rgba(0, 10, 20, 0.9);
            border: 2px solid var(--ui-blue);
            padding: 20px;
            display: none;
            text-align: center;
        }

        .interaction-hint {
            position: absolute;
            bottom: 100px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #fff;
            text-shadow: 0 0 10px var(--ui-blue);
            display: none;
        }

        .scanline {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 20;
            opacity: 0.3;
        }
    </style>
</head>
<body>

    <div class="scanline"></div>

    <div id="hud">
        <div class="stat-panel" style="width: 200px;">
            <div class="label">Avatar: PLAYER_01</div>
            <div class="progress-bar"><div id="hp-fill"></div></div>
            <div style="margin-top: 5px; font-size: 10px;">HP: 100/100</div>
        </div>

        <div class="stat-panel quest-tracker">
            <div class="label">Objectif Actuel</div>
            <div class="value" id="quest-title">Parler au Commandant</div>
            <div id="quest-progress">En attente d'ordres...</div>
        </div>

        <div id="dialogue-box">
            <div class="label" id="dialogue-name">NOM</div>
            <div id="dialogue-text">Texte du dialogue...</div>
            <div style="margin-top: 10px; font-size: 10px; color: var(--ui-orange);">[ESPACE] POUR CONTINUER</div>
        </div>

        <div class="interaction-hint" id="hint">APPUIE SUR [ESPACE] POUR PARLER</div>

        <div style="display: flex; justify-content: center; align-items: flex-end; height: 100%;">
            <div class="stat-panel" style="text-align: center; border-bottom: 2px solid var(--ui-pink);">
                <div class="label">Contrôles</div>
                <div style="font-size: 11px;">ZQSD: Bouger | ENTREE: Attaquer | ESPACE: Interagir</div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        /**
         * CYBER-ODYSSEY ONLINE ENGINE
         */

        let scene, camera, renderer, clock;
        let player, npc, worldFloor;
        let monsters = [], particles = [];
        let otherPlayers = [];
        
        // États du jeu
        const keys = {};
        let questState = 0; // 0: No Quest, 1: Active, 2: Done
        let killedCount = 0;
        const TARGET_KILL = 5;
        let isDialogOpen = false;

        // Configuration Physique
        let playerVel = new THREE.Vector3();
        const MOVE_SPEED = 0.15;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020408);
            scene.fog = new THREE.FogExp2(0x020408, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // Lumières
            const ambient = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambient);
            const directional = new THREE.DirectionalLight(0x00f2ff, 1);
            directional.position.set(10, 20, 10);
            scene.add(directional);

            setupWorld();
            setupEntities();

            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function setupWorld() {
            // Sol Technologique
            const grid = new THREE.GridHelper(200, 50, 0x00f2ff, 0x051020);
            scene.add(grid);

            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshPhongMaterial({ color: 0x050505, shininess: 10 });
            worldFloor = new THREE.Mesh(floorGeo, floorMat);
            worldFloor.rotation.x = -Math.PI / 2;
            scene.add(worldFloor);
        }

        function setupEntities() {
            // Le Joueur
            const playerGeo = new THREE.BoxGeometry(1, 2, 1);
            const playerMat = new THREE.MeshPhongMaterial({ color: 0x00f2ff });
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.y = 1;
            scene.add(player);

            // Le PNJ de Quête
            const npcGeo = new THREE.CylinderGeometry(0.5, 0.5, 2, 8);
            const npcMat = new THREE.MeshPhongMaterial({ color: 0xffaa00 });
            npc = new THREE.Mesh(npcGeo, npcMat);
            npc.position.set(0, 1, -10);
            scene.add(npc);

            // Icône de quête flottante
            const iconGeo = new THREE.OctahedronGeometry(0.3);
            const iconMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
            npc.questIcon = new THREE.Mesh(iconGeo, iconMat);
            npc.questIcon.position.y = 2;
            npc.add(npc.questIcon);

            // Simulation MMO: Autres joueurs (IA)
            for(let i=0; i<10; i++) {
                const other = new THREE.Mesh(playerGeo, new THREE.MeshPhongMaterial({ color: 0x555555 }));
                other.position.set((Math.random()-0.5)*100, 1, (Math.random()-0.5)*100);
                scene.add(other);
                otherPlayers.push({ mesh: other, target: new THREE.Vector3() });
            }
        }

        function handleKeyDown(e) {
            keys[e.key.toLowerCase()] = true;

            // Attaque
            if (e.key === 'Enter') {
                performAttack();
            }

            // Interaction
            if (e.code === 'Space') {
                if (isDialogOpen) {
                    closeDialogue();
                } else {
                    checkInteraction();
                }
            }
        }

        function checkInteraction() {
            const dist = player.position.distanceTo(npc.position);
            if (dist < 4) {
                openDialogue("COMMANDANT KAEL", getDialogueText());
            }
        }

        function getDialogueText() {
            if (questState === 0) return "Soldat ! Les drones de surveillance ont été corrompus. Détruisez 5 drones pour nettoyer la zone !";
            if (questState === 1 && killedCount < TARGET_KILL) return "Il reste des drones actifs. Continuez le combat !";
            if (questState === 1 && killedCount >= TARGET_KILL) {
                questState = 2;
                return "Excellent travail. La zone est sécurisée. Vous êtes une légende !";
            }
            return "Repos, soldat. La mission est accomplie.";
        }

        function openDialogue(name, text) {
            isDialogOpen = true;
            document.getElementById('dialogue-name').innerText = name;
            document.getElementById('dialogue-text').innerText = text;
            document.getElementById('dialogue-box').style.display = 'block';
            
            if (questState === 0) {
                questState = 1;
                updateQuestUI();
                spawnMonsters();
            }
        }

        function closeDialogue() {
            isDialogOpen = false;
            document.getElementById('dialogue-box').style.display = 'none';
            updateQuestUI();
        }

        function updateQuestUI() {
            const title = document.getElementById('quest-title');
            const prog = document.getElementById('quest-progress');

            if (questState === 0) {
                title.innerText = "Parler au Commandant";
                prog.innerText = "Trouvez Kael au centre.";
            } else if (questState === 1) {
                title.innerText = "Nettoyage de Zone";
                prog.innerText = `Drones neutralisés : ${killedCount} / ${TARGET_KILL}`;
            } else {
                title.innerText = "Mission Accomplie";
                prog.innerText = "Zone sécurisée.";
            }
        }

        function spawnMonsters() {
            if (monsters.length > 0) return;
            for(let i=0; i<8; i++) {
                const monsterGeo = new THREE.IcosahedronGeometry(0.8);
                const monsterMat = new THREE.MeshPhongMaterial({ color: 0xff00ff, wireframe: true });
                const m = new THREE.Mesh(monsterGeo, monsterMat);
                m.position.set((Math.random()-0.5)*40, 1.5, (Math.random()-0.5)*40 - 10);
                m.hp = 1;
                scene.add(m);
                monsters.push(m);
            }
        }

        function performAttack() {
            // Effet visuel d'attaque
            const pulseGeo = new THREE.SphereGeometry(4, 16, 16);
            const pulseMat = new THREE.MeshBasicMaterial({ color: 0x00f2ff, transparent: true, opacity: 0.5 });
            const pulse = new THREE.Mesh(pulseGeo, pulseMat);
            pulse.position.copy(player.position);
            scene.add(pulse);
            particles.push({ mesh: pulse, life: 1.0 });

            // Détection de dégâts
            monsters.forEach((m, index) => {
                if (m.position.distanceTo(player.position) < 4) {
                    m.hp -= 1;
                    if (m.hp <= 0) {
                        createExplosion(m.position);
                        scene.remove(m);
                        monsters.splice(index, 1);
                        if (questState === 1) {
                            killedCount++;
                            updateQuestUI();
                        }
                    }
                }
            });
        }

        function createExplosion(pos) {
            const expGeo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            const expMat = new THREE.MeshBasicMaterial({ color: 0xff00ff });
            for(let i=0; i<10; i++) {
                const p = new THREE.Mesh(expGeo, expMat);
                p.position.copy(pos);
                p.userData.vel = new THREE.Vector3((Math.random()-0.5)*0.2, Math.random()*0.2, (Math.random()-0.5)*0.2);
                scene.add(p);
                particles.push({ mesh: p, life: 1.0, isExp: true });
            }
        }

        function updatePlayer() {
            if (isDialogOpen) return;

            const move = new THREE.Vector3();
            if (keys['z']) move.z -= 1;
            if (keys['s']) move.z += 1;
            if (keys['q']) move.x -= 1;
            if (keys['d']) move.x += 1;

            if (move.length() > 0) {
                move.normalize().multiplyScalar(MOVE_SPEED);
                player.position.add(move);
                // Orientation
                const targetAngle = Math.atan2(move.x, move.z);
                player.rotation.y = targetAngle;
            }

            // Caméra suit le joueur
            camera.position.lerp(new THREE.Vector3(player.position.x, player.position.y + 10, player.position.z + 15), 0.1);
            camera.lookAt(player.position);

            // Hint interaction
            if (player.position.distanceTo(npc.position) < 4) {
                document.getElementById('hint').style.display = 'block';
            } else {
                document.getElementById('hint').style.display = 'none';
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            updatePlayer();

            // Animation PNJ & Icône
            npc.questIcon.rotation.y += 0.05;
            npc.questIcon.position.y = 2 + Math.sin(time * 2) * 0.2;

            // Animation Monstres (ils tournent un peu)
            monsters.forEach(m => {
                m.rotation.x += 0.02;
                m.rotation.y += 0.02;
                m.position.y = 1.5 + Math.sin(time * 3 + m.position.x) * 0.3;
            });

            // Simulation MMO: Mouvement des autres joueurs
            otherPlayers.forEach(p => {
                if (Math.random() > 0.98) {
                    p.target.set((Math.random()-0.5)*100, 1, (Math.random()-0.5)*100);
                }
                p.mesh.position.lerp(p.target, 0.01);
            });

            // Gestion particules & effets
            particles.forEach((p, i) => {
                p.life -= 0.02;
                if (p.isExp) {
                    p.mesh.position.add(p.userData.vel);
                } else {
                    p.mesh.scale.multiplyScalar(1.05);
                    p.mesh.material.opacity = p.life;
                }

                if (p.life <= 0) {
                    scene.remove(p.mesh);
                    particles.splice(i, 1);
                }
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.onload = init;
    </script>
</body>
</html>
